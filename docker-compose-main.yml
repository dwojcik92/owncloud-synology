version: '3.2'

services:
  syncthing:
    image: syncthing/syncthing
    restart: always
    ports:
      - "8384:8384"
      - "22000:22000"
      - "21027:21027/udp"
    volumes:
      - "syncthing-config:/var/syncthing/.config/syncthing"
      - "syncthing-data:/var/syncthing"

  homeassistant:
      image: homeassistant/home-assistant
      volumes:
        - homeassistant-config:/config
      ports:
        - "18123:8123"

  grafana:
    image: grafana/grafana
    ports:
      - 13000:3000
    volumes:
      - homecloud-grafana:/var/lib/grafana

  influxdb:
    image: influxdb:latest
    ports:
      - '18086:8086'
    volumes:
      - homecloud-influxdb:/var/lib/influxdb
    environment:
      - INFLUXDB_DB=ds918
      - INFLUXDB_ADMIN_USER=synology
      - INFLUXDB_ADMIN_PASSWORD=synology

  spark:
    image: docker.io/bitnami/spark:3-debian-10
    environment:
      - SPARK_MODE=master
      - SPARK_RPC_AUTHENTICATION_ENABLED=no
      - SPARK_RPC_ENCRYPTION_ENABLED=no
      - SPARK_LOCAL_STORAGE_ENCRYPTION_ENABLED=no
      - SPARK_SSL_ENABLED=no
    ports:
      - '8080:8080'
      - '7077:7077'
  spark-worker-1:
    image: docker.io/bitnami/spark:3-debian-10
    environment:
      - SPARK_MODE=worker
      - SPARK_MASTER_URL=spark://spark:7077
      - SPARK_WORKER_MEMORY=1G
      - SPARK_WORKER_CORES=1
      - SPARK_RPC_AUTHENTICATION_ENABLED=no
      - SPARK_RPC_ENCRYPTION_ENABLED=no
      - SPARK_LOCAL_STORAGE_ENCRYPTION_ENABLED=no
      - SPARK_SSL_ENABLED=no

  minio:
    image: minio/minio:latest
    environment:
      MINIO_ACCESS_KEY: "minio"
      MINIO_SECRET_KEY: "minio"
    ports:
      - 19000:9000
    volumes:
      - minio-database:/data
    command: server /data

volumes:
  syncthing-config:
    driver:      local
    driver_opts:
      type:      none
      device:    /volume2/homecloud/syncthing/config
      o:         bind

  syncthing-data:
    driver:      local
    driver_opts:
      type:      none
      device:    /volume2/homecloud/syncthing/data
      o:         bind

  homecloud-grafana:
    driver:      local
    driver_opts:
      type:      none
      device:    /volume2/homecloud/grafana
      o:         bind
  homecloud-influxdb:
    driver:      local
    driver_opts:
      type:      none
      device:    /volume2/homecloud/influxdb
      o:         bind

  homeassistant-config:
    driver:      local
    driver_opts:
      type:      none
      device:    /volume2/homecloud/homeassistant/config
      o:         bind

  minio-database:
    driver:      local
    driver_opts:
      type:      none
      device:    /volume2/homecloud/MinIO
      o:         bind